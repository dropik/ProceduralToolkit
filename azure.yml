trigger:
  - preview

pool: default

jobs:
  - job: Test
    displayName: ProceduralToolkit Test
    steps:
      - task: PowerShell@2
        inputs:
          filePath: 'testrun.ps1'
          arguments: '-testType Unit -batchMode -enableCodeCoverage'
        displayName: Unit Tests
  
      - task: PowerShell@2
        inputs:
          filePath: 'testrun.ps1'
          arguments: '-testType UI -batchMode'
        displayName: UI Tests
  
      - task: PowerShell@2
        inputs:
          filePath: 'testrun.ps1'
          arguments: '-testType E2E -batchMode'
        displayName: E2E Tests

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'NUnit'
          testResultsFiles: 'TestResults/*.xml'
          failTaskOnFailedTests: true
        displayName: Publish test results

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: Logs
          artifactName: Logs
        displayName: Publish Unit tests log

      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: cobertura
          summaryFileLocation: CodeCoverage/Cobertura.xml
        displayName: Publish code coverage

  - job: PushToMaster
    displayName: Push ProceduralToolkit To Master
    dependsOn: Test
    steps:
      - checkout: self
        clean: true
        persistCredentials: true
      
      - script: |
          git branch -D master
          git checkout --track origin/master
          git merge origin/preview
          git push
        displayName: Push
